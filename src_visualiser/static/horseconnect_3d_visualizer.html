<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HorseConnect 3D Viewer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="icon" type="image/svg+xml" href="static/favicon.ico" />
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.0/examples/js/loaders/PLYLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.0/examples/js/controls/OrbitControls.js"></script>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background-color: #f4f4f4; display: flex; height: 100vh; }
    .sidebar { width: 220px; background-color: #0d7b61; color: white; display: flex; flex-direction: column; justify-content: space-between; position: fixed; height: 100vh; }
    .sidebar img { max-height: 100px; margin: 20px auto; display: block; }
    .sidebar nav { display: flex; flex-direction: column; padding: 10px; }
    .sidebar button { background: none; border: none; color: white; padding: 12px; text-align: left; font-size: 16px; cursor: pointer; transition: background 0.3s; }
    .sidebar button:hover, .sidebar button.active { background-color: #189273; }
    .sidebar footer { text-align: center; padding: 10px; font-size: 14px; }
    .main { margin-left: 240px; flex-grow: 1; padding: 20px; overflow-y: auto; }
    .tabs { margin: 20px 0; }
    .tab-button { padding: 10px; margin: 5px; background-color: #0d7b61; color: white; border: none; cursor: pointer; }
    .tab-button.active { background-color: #189273; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    #loadingOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; font-size: 24px; z-index: 9999; display: none; }
    #threejs-container { width: 100%; height: 500px; margin-top: 20px; background: #eaeaea; }
    .slider-control { margin: 10px 0; }
    .slider-control label { display: block; font-weight: bold; margin-bottom: 5px; }
    .slider-control input { width: 100%; }
    #playToggleBtn { background-color: #0d7b61; color: white; padding: 10px 20px; border: none; cursor: pointer; border-radius: 10px; margin-top: 20px; }
  </style>
</head>
<body>
  <div id="loadingOverlay">Loading...</div>
  <div class="sidebar">
    <div>
      <img src="static/logo.png" alt="Logo" />
      <nav>
        <button id="btnHorses" class="active">Sequences</button>
      </nav>
    </div>
    <footer>&copy; 2025 MIoT GROUP 03</footer>
  </div>

  <div class="main">
    <h2 id="sectionTitle">3D Sequence Viewer</h2>
    <div class="slider-control">
      <label for="pointSizeSlider">Point Size:</label>
      <input type="range" id="pointSizeSlider" min="0.005" max="0.2" step="0.005" value="0.03" />
      <span id="pointSizeValue">0.03</span>
    </div>
    <div class="slider-control">
      <label for="fpsSlider">Frame Rate (FPS):</label>
      <input type="range" id="fpsSlider" min="1" max="60" step="1" value="30" />
      <span id="fpsValue">30</span>
    </div>
    <button id="playToggleBtn">Play</button>
    <div class="tabs" id="sequenceTabs"></div>
    <div id="threejs-container"></div>
  </div>

  <script>
    let currentSequence = null;
    let pointSize = 0.03;
    let fps = 30;
    let frameDelay = 1000 / fps;
    let isPlaying = false;
    let frameIndex = 0;
    let pointClouds = [];
    let frameNames = [];
    let scene, camera, renderer, controls;

    function setup3DScene() {
      const container = document.getElementById("threejs-container");
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xeaeaea);
      camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
      camera.position.z = 1;

      renderer = new THREE.WebGLRenderer();
      renderer.setSize(container.clientWidth, container.clientHeight);
      container.appendChild(renderer.domElement);

      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      const light = new THREE.SpotLight(0xffffff);
      light.position.set(20, 20, 20);
      scene.add(light);
      scene.add(new THREE.AmbientLight(0xffffff, 0.5));

      animate();
    }

    function animate(timestamp) {
      requestAnimationFrame(animate);
      if (isPlaying && frameNames.length && timestamp - lastRender > frameDelay) {
        showNextFrame();
        lastRender = timestamp;
      }
      renderer.render(scene, camera);
      controls.update();
    }

    function showNextFrame() {
      if (!pointClouds.length) return;
      pointClouds[frameIndex].visible = false;
      frameIndex = (frameIndex + 1) % pointClouds.length;
      pointClouds[frameIndex].visible = true;
    }

    function preloadFrames(callback) {
      pointClouds = [];
      const loader = new THREE.PLYLoader();
      let loaded = 0;
      frameNames.forEach((file, i) => {
        loader.load(`/download_ply/${file}`, geometry => {
          const material = new THREE.PointsMaterial({ size: pointSize, vertexColors: true });
          const points = new THREE.Points(geometry, material);
          points.scale.set(1000, 1000, 1000);
          points.rotation.x = Math.PI;
          points.visible = false;
          scene.add(points);
          pointClouds[i] = points;
          if (++loaded === frameNames.length) callback();
        });
      });
    }

    function loadSequences() {
      fetch("/get_containers")
        .then(r => r.json())
        .then(data => {
          const tabBar = document.getElementById("sequenceTabs");
          tabBar.innerHTML = "";
          data.forEach(name => {
            const btn = document.createElement("button");
            btn.className = "tab-button";
            btn.innerText = name;
            btn.onclick = () => selectSequence(name);
            tabBar.appendChild(btn);
          });
        });
    }

    function selectSequence(name) {
      currentSequence = name;
      fetch("/get_visualization", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `container_name=${name}`
      }).then(() => {
        fetch("/get_framesURL")
          .then(r => r.json())
          .then(data => {
            frameNames = data;
            frameIndex = 0;
            preloadFrames(() => {
              pointClouds[0].visible = true;
              console.log("Frames ready");
            });
          });
      });
    }

    document.getElementById("pointSizeSlider").oninput = e => {
      pointSize = parseFloat(e.target.value);
      document.getElementById("pointSizeValue").textContent = pointSize;
      pointClouds.forEach(pc => { pc.material.size = pointSize; pc.material.needsUpdate = true; });
    };

    document.getElementById("fpsSlider").oninput = e => {
      fps = parseInt(e.target.value);
      document.getElementById("fpsValue").textContent = fps;
      frameDelay = 1000 / fps;
    };

    document.getElementById("playToggleBtn").onclick = () => {
      isPlaying = !isPlaying;
      document.getElementById("playToggleBtn").textContent = isPlaying ? "Pause" : "Play";
    };

    let lastRender = performance.now();
    setup3DScene();
    loadSequences();
  </script>
</body>
</html>
